---
title: "Preterm - Birth"
subtitle: "Logistic Regression"
author: "R.G. Thomas"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
geometry: "left=3cm,right=5cm,top=2cm,bottom=2cm"
output:
  pdf_document:
    toc: true
    number_sections: true
    highlight: tango
    keep_tex: true 
---    
    

```{r global_options, include=FALSE}
# these are some optional settings that will change how some features look
# you do not need to change them.
knitr::opts_chunk$set(out.width = "50%", out.height="50%", fig.align="center", warning=FALSE, message=FALSE)
```


```{r, include=FALSE}


hoslem=function (obs, pred, g = 0)
  {
  if (g == 0)
  g = round(min(length(obs)/10, 10))
  ord <- order(pred)
  obs.o <- obs[ord]
  pred.o <- pred[ord]
  interval = cut(pred.o, quantile(pred.o, 0:g/g), include.lowest = TRUE)
  counts = xtabs(formula = cbind(obs.o, pred.o) ~ interval)
  centers <- aggregate(formula = pred.o ~ interval, FUN = "mean")
  pear.res <- (counts[, "obs.o"] - counts[, "pred.o"])/sqrt(counts[,
  "pred.o"])
  pearson <- sum(pear.res^2)
  if (any(counts[, "pred.o"] < 5))
  warning("Some expected counts are less than 5. Use smaller number of groups")
  p = 1 - pchisq(pearson, g - 2)
  results <- as.data.frame(cbind(counts[, "obs.o"], counts[,
  "pred.o"], centers$pred.o, pear.res))
  colnames(results) <- c("obs.o", "pred.o", "avg mean", "pearson resid")
  cat("Hosmer-Lemeshow test with", g, "bins", "\n", "Pearson Stat = ",
  pearson, "\n", "p = ", p, "\n \n")
  return(results)
  }

```


```{r, echo=FALSE}

library(tidyverse)
library(medicaldata)
library(knitr)
library(kableExtra)
library(car)
library(logistf)
library(ResourceSelection)

# --- Notes --- 

# Remember this is a Clinical Trial we do not need to backward selection

# --- Referrences ---
# Soneji S, Beltrán-Sánchez H. Association of Maternal Cigarette Smoking and Smoking Cessation With Preterm Birth. JAMA Netw Open. 2019;2(4):e192514. doi:10.1001/jamanetworkopen.2019.2514



```
In this phase of the analysis, we concentrate on two secondary outcomes: preterm birth, defined as delivery before 37 weeks, and low birthweight, with the threshold set at below 2500g. It's essential to note that these outcomes are secondary in the context of the clinical trial, where the power calculation was based on gestational age at delivery. This serves as a reminder that our statistical power might be limited for these secondary outcomes, potentially impacting our ability to detect statistical significance.

We are specifically interested in what preterm  birth and low birthweight is associated with. 

### Data Cleaning 
```{r}

opt_raw = opt

opt_logistic <- opt_raw %>%
  # turn space to NA in ended_37_wk
  mutate(
    cat_birthweight = factor(ifelse(Birthweight < 2500, 0, 1), 
                             levels = c(0, 1)),
    across(where(is.factor), ~na_if(as.character(.), "   "))
  ) %>%
  select(
    # Outcome
    Preg.ended...37.wk, cat_birthweight,
    # Center
    Clinic,
    # demographic
    Age, White, Black, Hisp, Education, Prev.preg, 
    # Coexisting medical condition
    Diabetes, Hypertension, Drug.Add, Use.Alc, Use.Tob, # eating disorder
    # dental status ?
    ## missing number of natural teeth
    N.qualifying.teeth, BL..BOP, BL.PD.avg
  )
  

```


### Logistic Regression

#### Part 1 - Preterm or Not Preterm

##### Model Fitting 
```{r, echo=FALSE}


# --- Fit Base Model ---
  
model.preterm <- glm(as.factor(Preg.ended...37.wk) ~ . - cat_birthweight, 
                     data = opt_logistic, 
          family = binomial, na.action = na.exclude)

model.preterm.summary <- summary(model.preterm)
model.preterm.summary$coefficients %>% 
  round(digits = 3) %>% kable()

# --- Variable Selection --- 

model.preterm.reduced <- glm(as.factor(Preg.ended...37.wk) ~ . - 
                               cat_birthweight - Drug.Add - Use.Alc  - Use.Tob, 
                             data = opt_logistic, 
          family = binomial, na.action = na.exclude)

model.preterm.reduced.summary <- summary(model.preterm.reduced)
model.preterm.reduced.summary$coefficients %>% 
  round(digits = 3) %>% kable()

```
We have two models above. The bigger model has these variables **Clinic**, **Age**, **Ethnicity**, **Education**, **Number of previous pregnancies**, **Diabetes**, **Hypertension**, **Alcohol use**, **Number of qualifying teeth**, **Percentage of sites bleeding on probing at baseline**, **Whole-mouth average pocket depth at baseline (mm)**, **Self-reported participant history of drug addiction** and **Self-reported participants history of alcohol use**. The reduced model does not have drug addiction and alcohol use variables. We are just curious if these vices are contributing to these secoundary outcomes in the sample.



```{r, echo=FALSE}
anova(model.preterm, model.preterm.reduced, test = "LRT")

```
- $H_{0}$: There is no statistical difference between the reduced and full model.
- $H_{A}$: There is statistical difference between the reduced and full model. 
- P-value: 0.508
- We fail to reject the null hypothesis at significance level 0.05.
- The full model does not perform better and we decided to go with the simpler model that does not have alcohol, drug and tobacco use. 



```{r, echo=FALSE}
compareCoefs(model.preterm,model.preterm.reduced) %>% kable()
```


We also checked the coefficients of both models to see if there is any significant change. As we can see from the table above, the coefficients do not change are within the standard errors.  



##### Final Model
```{r, echo=FALSE}

# --- Notes ---
# I am encountering errors here. It has to do with NAs in the data set. 
# We might have to impute? 

# length(opt_logistic$Preg.ended...37.wk) ---> N = 823 
# length(model.preterm.reduced$fitted.values) ---> N = 655
# 


# --- Goodness of Fit ---


# opt_logistic$Preg.ended...37.wk <- as.factor(opt_logistic$Preg.ended...37.wk )

# generalhoslem::logitgof(opt_logistic$Preg.ended...37.wk, 
#                         model.preterm.reduced$fitted.values)

# hoslem.test(model.preterm.reduced$fitted.values,
#             opt_logistic$Preg.ended...37.wk)

# --- Outlier Test ---
plot(model.preterm.reduced$fitted.values, rstandard(model.preterm.reduced))

```



#### Part 2 - Birthweight 

```{r, echo=FALSE}

opt_logistic$cat_birthweight <- as.factor(opt_logistic$cat_birthweight)

model.birthweight <- glm(cat_birthweight ~ . - Preg.ended...37.wk , 
                         data = opt_logistic, family = binomial, 
                         na.action = na.exclude)

summary(model.birthweight)


```

